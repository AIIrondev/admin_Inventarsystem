<!--
   Copyright 2025 Maximilian Gründinger

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
{% extends "base.html" %}

{% block title %}Backup{% endblock %}

{% block content %}

<h1>Backup Managment</h1>

<div class="container">
    <div class="content">
        <div class="items-wrap">
            <div id="items-container" class="items-container">
                <!-- Items will be dynamically loaded here -->
            </div>
            <button class="scroll-btn left" aria-label="Nach links scrollen">&#8249;</button>
            <button class="scroll-btn right" aria-label="Nach rechts scrollen">&#8250;</button>
            <div class="fade left" aria-hidden="true"></div>
            <div class="fade right" aria-hidden="true"></div>
        </div>
    </div>
    <div id="item-modal" class="item-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modal-content-wrapper">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
    <a class="run-backup" href="{{ url_for('run_backup') }}">Generate new Backup</a>

    <div class="upload-card">
        <h2>Backup hochladen</h2>
        <p class="sub">Erlaubt: .tar.gz — die Datei wird als Inventarsystem-YYYY-MM-DD.tar.gz gespeichert.</p>

        <div id="dropzone" class="dropzone" tabindex="0" role="button" aria-label="Datei hierhin ziehen oder klicken zum Auswählen">
            <div class="dz-icon">⬆️</div>
            <div class="dz-text">
                Datei hierher ziehen oder klicken, um auszuwählen
            </div>
            <input id="fileInput" type="file" name="file" accept=".tar.gz" hidden>
        </div>

        <div id="selectedFile" class="selected-file" style="display:none;"></div>

        <div id="progressWrap" class="progress-wrap" style="display:none;">
            <div id="progressBar" class="progress-bar"></div>
        </div>

        <div id="uploadMsg" class="upload-msg" role="status"></div>

        <div class="upload-actions">
            <button id="startUpload" class="primary" disabled>Hochladen</button>
            <button id="cancelUpload" class="ghost" style="display:none;">Abbrechen</button>
        </div>
    </div>
</div>
<script>
      // Add this line to define allItems globally
    let allItems = [];

    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;');
    }

    function updateFades(container, wrap) {
        if (!wrap) return;
        const atStart = container.scrollLeft <= 0;
        const atEnd = container.scrollLeft + container.clientWidth >= container.scrollWidth - 1;
        wrap.classList.toggle('at-start', atStart);
        wrap.classList.toggle('at-end', atEnd);
    }

    function loadItems() {
        fetch("{{ url_for('get_backups') }}")
            .then(response => response.json())
            .then(data => {
                const itemsContainer = document.querySelector('#items-container');
                const wrap = itemsContainer.closest('.items-wrap');

                // Store all items data globally for filter rebuilding
                allItems = data.items || [];
                
                // Clear the container first
                itemsContainer.innerHTML = '';
                
                if (!data.items || data.items.length === 0) {
                    itemsContainer.innerHTML = '<div class="no-items-message">Keine Objekte gefunden</div>';
                    updateFades(itemsContainer, wrap);
                    return;
                }

                // Sort items by name in ascending order (A-Z)
                data.items.sort((a, b) => {
                    const nameA = a.Name ? a.Name.toLowerCase() : '';
                    const nameB = b.Name ? b.Name.toLowerCase() : '';
                    return nameA.localeCompare(nameB); // Ascending order
                });
                
                data.items.forEach(item => {
                    try {
                        const card = document.createElement('div');
                        card.classList.add('item-card');
                        
                        // Add class to make card clickable 
                        card.classList.add('clickable-card');
                        const downloadBase = "{{ url_for('download_backup', date='') }}";
                        const downloadNegative = "{{ url_for('restore', date='') }}";
                        // When rendering each card in JS:
                        // Use a link (GET) instead of a POSTing form, and encode the date.
                        const href = downloadBase + encodeURIComponent(item.date);
                        const date_negative = downloadNegative + encodeURIComponent(item.date);
                        const sizeBadge = (item.size) ? `<span class="badge">${escapeHtml(item.size)}</span>` : '';
                        card.innerHTML = `
                            <div class="card-content" data-item-id="${escapeHtml(item.date)}">
                                <div class="card-header">
                                    <h3>${escapeHtml(item.date || '-')}</h3>
                                    ${sizeBadge}
                                </div>
                                <div class="preview"><span class="label">Vorschau:</span>
                                    <pre class="preview-code">${escapeHtml(item.content_prev || item.content || '-')}</pre>
                                </div>
                            </div>
                            <div class="actions">
                                <a class="download" href="${href}">Download</a>
                                <a class="restore" href="${date_negative}">Restore</a>
                            </div>
                        `;
                        itemsContainer.appendChild(card);
                        
                        // Add direct click event listeners to the card content area
                        const cardContent = card.querySelector('.card-content');
                        if (cardContent) {
                            cardContent.addEventListener('click', function(e) {
                                // Don't trigger if clicking on buttons or form elements
                                if (e.target.tagName === 'BUTTON' || 
                                    e.target.tagName === 'A' || 
                                    e.target.tagName === 'INPUT' ||
                                    e.target.closest('button') || 
                                    e.target.closest('a')
                                )
                                
                                // Stop event from bubbling up
                                e.stopPropagation();
                                
                                // Get full item data with correct image paths
                                const modalItemData = {...item};

                                openItemModal(modalItemData);
                            });
                        }
                    } catch (err) {
                        console.error('Error processing item:', err, item);
                    }
                });
                
                // Start display from leftmost position (first card, which is now Z)
                itemsContainer.scrollLeft = 0;
                updateFades(itemsContainer, wrap);
                itemsContainer.addEventListener('scroll', () => updateFades(itemsContainer, wrap), { passive: true });

            })
            .catch(error => {
                console.error('Error fetching items:', error);
                const itemsContainer = document.querySelector('#items-container');
                itemsContainer.innerHTML = 
                    '<div class="error-message">Fehler beim Laden der Objekte. Bitte versuchen Sie es später erneut.</div>';
            });
    }
    function openItemModal(item) {
        // Get modal elements
        const modal = document.getElementById('item-modal');
        const modalContent = document.getElementById('modal-content-wrapper');
        
                // Build modal content HTML
                const downloadBase = "{{ url_for('download_backup', date='') }}";
                const downloadNegative = "{{ url_for('restore', date='') }}";
                const href = downloadBase + encodeURIComponent(item.date);
                const date_negative = downloadNegative + encodeURIComponent(item.date);
                modalContent.innerHTML = `
                        <div class="modal-header">
                            <h2>${escapeHtml('Inventarsystem-' + (item.date || '-'))}</h2>
                        </div>
                        <div class="modal-details">
                                <div class="detail-group">
                                        <div class="detail-label">Size:</div>
                                        <div class="detail-value">${escapeHtml(item.size || '-')}</div>
                                </div>
                                <div class="detail-group">
                                        <div class="detail-label">Content:</div>
                                        <pre class="detail-pre">${escapeHtml(item.content || '-')}</pre>
                                </div>
                        </div>
                        <div class="actions">
                            <a class="download" href="${href}">Download</a>
                            <a class="restore" href="${date_negative}">Restore</a>
                        </div>
                `;
        
        // Show the modal
        modal.style.display = 'block';
        
        // Set up close button
        const closeButton = modal.querySelector('.close-modal');
        closeButton.onclick = function() {
            modal.style.display = 'none';
        };
        
        
        // Set up click outside to close
        window.onclick = function(event) {
            const itemModal = document.getElementById('item-modal');
            const scheduleModal = document.getElementById('schedule-modal');
            
            if (event.target === itemModal) {
                itemModal.style.display = 'none';
            }
            if (scheduleModal && event.target === scheduleModal) {
                scheduleModal.style.display = 'none';
            }
        };
        
    }
        document.addEventListener('DOMContentLoaded', () => {
            loadItems();
            const wrap = document.querySelector('.items-wrap');
            const container = document.querySelector('#items-container');
            if (wrap && container) {
                const leftBtn = wrap.querySelector('.scroll-btn.left');
                const rightBtn = wrap.querySelector('.scroll-btn.right');
                const scrollBy = () => Math.max(280, Math.floor(container.clientWidth * 0.8));
                if (leftBtn) leftBtn.addEventListener('click', () => container.scrollBy({ left: -scrollBy(), behavior: 'smooth' }));
                if (rightBtn) rightBtn.addEventListener('click', () => container.scrollBy({ left: scrollBy(), behavior: 'smooth' }));
            }

            // Upload UI logic
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');
            const startBtn = document.getElementById('startUpload');
            const cancelBtn = document.getElementById('cancelUpload');
            const selFile = document.getElementById('selectedFile');
            const msg = document.getElementById('uploadMsg');
            const progressWrap = document.getElementById('progressWrap');
            const progressBar = document.getElementById('progressBar');
            let currentFile = null;
            let xhr = null;

            function setMessage(text, type = 'info') {
                msg.textContent = text || '';
                msg.className = `upload-msg ${type}`;
            }

            function resetUpload() {
                currentFile = null;
                xhr = null;
                fileInput.value = '';
                selFile.style.display = 'none';
                selFile.textContent = '';
                startBtn.disabled = true;
                cancelBtn.style.display = 'none';
                progressWrap.style.display = 'none';
                progressBar.style.width = '0%';
                setMessage('');
            }

            function chooseFile(file) {
                if (!file) return;
                if (!file.name.toLowerCase().endsWith('.tar.gz')) {
                    setMessage('Falsches Dateiformat. Erlaubt ist nur .tar.gz', 'error');
                    return;
                }
                currentFile = file;
                selFile.style.display = 'block';
                selFile.textContent = `${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
                startBtn.disabled = false;
                setMessage('Bereit zum Hochladen');
            }

            dropzone.addEventListener('click', () => fileInput.click());
            dropzone.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    fileInput.click();
                }
            });
            fileInput.addEventListener('change', (e) => chooseFile(e.target.files[0]));
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('drag'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    chooseFile(e.dataTransfer.files[0]);
                }
            });

            startBtn.addEventListener('click', () => {
                if (!currentFile) return;
                const form = new FormData();
                form.append('file', currentFile);
                xhr = new XMLHttpRequest();
                xhr.open('POST', '{{ url_for("upload_file") }}', true);
                xhr.responseType = 'json';

                xhr.upload.onprogress = function (e) {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        progressWrap.style.display = 'block';
                        progressBar.style.width = pct + '%';
                    }
                };
                xhr.onload = function () {
                    cancelBtn.style.display = 'none';
                    if (xhr.status >= 200 && xhr.status < 300) {
                        setMessage(xhr.response?.message || 'Upload erfolgreich', 'success');
                        // refresh backups list
                        loadItems();
                        resetUpload();
                    } else {
                        const err = xhr.response?.error || `Fehler: ${xhr.status}`;
                        setMessage(err, 'error');
                    }
                };
                xhr.onerror = function () {
                    cancelBtn.style.display = 'none';
                    setMessage('Netzwerkfehler beim Hochladen', 'error');
                };

                cancelBtn.style.display = 'inline-block';
                setMessage('Lade hoch...');
                xhr.send(form);
            });

            cancelBtn.addEventListener('click', () => {
                if (xhr) {
                    xhr.abort();
                }
                resetUpload();
                setMessage('Upload abgebrochen', 'info');
            });
        });
</script>
<style>
/* Container */
.container {
    background-color: #fff;
    padding: 24px;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    width: 90%;
    max-width: 1200px;
    margin: 20px auto;
}

/* Headings */
h1, h2 { text-align: center; }
h1 { margin-bottom: 8px; }

/* Items list */
.items-container {
    display: flex;
    overflow-x: auto;
    gap: 16px;
    padding: 16px 0 8px;
    scroll-snap-type: x mandatory;
    scroll-padding: 16px;
    -webkit-overflow-scrolling: touch;
}
.items-container::-webkit-scrollbar { height: 10px; }
.items-container::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 999px; }
.items-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
.items-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
.items-wrap { position: relative; }
.fade {
    position: absolute;
    top: 0; bottom: 0;
    width: 40px;
    pointer-events: none;
}
.fade.left { left: 0; background: linear-gradient(90deg, #fff 0%, rgba(255,255,255,0) 100%); opacity: 1; transition: opacity .2s; }
.fade.right { right: 0; background: linear-gradient(270deg, #fff 0%, rgba(255,255,255,0) 100%); opacity: 1; transition: opacity .2s; }
.items-wrap.at-start .fade.left { opacity: 0; }
.items-wrap.at-end .fade.right { opacity: 0; }

.scroll-btn {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    width: 36px; height: 36px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #111827;
    display: inline-flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    cursor: pointer;
}
.scroll-btn.left { left: -12px; }
.scroll-btn.right { right: -12px; }
.scroll-btn:hover { background: #f9fafb; }

.item-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    width: 320px;
    flex-shrink: 0;
    scroll-snap-align: center;
    box-shadow: 0 1px 6px rgba(0,0,0,0.06);
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    cursor: pointer;
}
.item-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); border-color: #d1d5db; }
.item-card .card-content { display: grid; gap: 8px; }
.item-card .card-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.item-card h3 { margin: 0; font-size: 1.05rem; color: #111827; font-weight: 600; }
.item-card .badge { background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; padding: 2px 8px; border-radius: 999px; font-size: .85rem; }
.item-card .label { font-size: .85rem; color: #6b7280; }
.preview { display: grid; gap: 4px; }
.preview-code { margin: 0; padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 6.5rem; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .85rem; line-height: 1.25rem; white-space: pre-wrap; }

/* Modal */
.item-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(17,24,39,0.45);
    z-index: 1000;
    display: none;
}
.modal-content {
    background: #ffffff;
    margin: 8vh auto 0;
    padding: 20px 24px;
    border-radius: 12px;
    width: 92%;
    max-width: 720px;
    max-height: 74vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.18);
}
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.close-modal {
    float: right;
    font-size: 28px;
    cursor: pointer;
    color: #9ca3af;
}
.close-modal:hover, .close-modal:focus { color: #111827; }

/* Messages */
.error-message, .no-items-message {
    padding: 16px;
    text-align: center;
    width: 100%;
    color: #842029;
    background-color: #f8d7da;
    border: 1px solid #f5c2c7;
    border-radius: 8px;
    margin: 16px 0;
}

/* Actions */
.actions {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e5e7eb;
    flex-wrap: wrap;
}
.actions form { margin: 0; display: flex; }
.actions button, .actions a {
    min-width: 120px;
    height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.actions a.download {
    background: #2563eb;
    color: #ffffff;
    border-radius: 8px;
    text-decoration: none;
    padding: 8px 14px;
    border: 1px solid #1d4ed8;
}
.actions a.download:hover { background: #1d4ed8; }

.modal-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;}
.detail-pre { margin: 0; padding: 10px 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 50vh; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .9rem; }

/* Generate backup button */
.run-backup {
    display: inline-block;
    margin-top: 16px;
    background: #059669;
    color: #ffffff;
    border-radius: 8px;
    text-decoration: none;
    padding: 10px 16px;
    border: 1px solid #047857;
}
.run-backup:hover { background: #047857; }

/* Responsive */
@media (max-width: 640px) {
    .item-card { width: 85vw; }
}

/* Upload card */
.upload-card { margin-top: 20px; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
.upload-card h2 { margin: 0 0 6px 0; font-size: 1.1rem; }
.upload-card .sub { margin: 0 0 12px 0; color: #6b7280; font-size: .95rem; }
.dropzone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; background: #f8fafc; }
.dropzone.drag { background: #eef2ff; border-color: #a5b4fc; }
.dz-icon { font-size: 28px; margin-bottom: 6px; }
.selected-file { margin-top: 10px; color: #111827; }
.progress-wrap { margin-top: 10px; height: 10px; background: #f3f4f6; border-radius: 999px; overflow: hidden; }
.progress-bar { height: 100%; width: 0%; background: #3b82f6; transition: width .2s ease; }
.upload-msg { margin-top: 10px; }
.upload-msg.error { color: #b91c1c; }
.upload-msg.success { color: #14532d; }
.upload-actions { margin-top: 12px; display: flex; gap: 8px; }
.upload-actions .primary { background: #2563eb; color: #fff; border: 1px solid #1d4ed8; border-radius: 8px; padding: 8px 14px; }
.upload-actions .primary:disabled { opacity: .6; cursor: not-allowed; }
.upload-actions .ghost { background: transparent; color: #111827; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 14px; }

/* Dark mode (optional) */
@media (prefers-color-scheme: dark) {
    .container { background: #0b1220; box-shadow: 0 2px 12px rgba(0,0,0,0.6); }
    .items-container::-webkit-scrollbar-track { background: #111827; }
    .items-container::-webkit-scrollbar-thumb { background: #374151; }
    .item-card { background: #0f172a; border-color: #1f2937; box-shadow: 0 1px 6px rgba(0,0,0,0.5); }
    .item-card:hover { border-color: #334155; box-shadow: 0 8px 24px rgba(0,0,0,0.6); }
    .item-card h3 { color: #e5e7eb; }
    .label { color: #cbd5e1; }
    .preview-code, .detail-pre { background: #0b1220; border-color: #1f2937; color: #e5e7eb; }
    .badge { background: #1e293b; color: #c7d2fe; border-color: #334155; }
    .fade.left { background: linear-gradient(90deg, #0b1220 0%, rgba(11,18,32,0) 100%); }
    .fade.right { background: linear-gradient(270deg, #0b1220 0%, rgba(11,18,32,0) 100%); }
    .scroll-btn { background: #0f172a; color: #e5e7eb; border-color: #1f2937; }
    .modal-content { background: #0f172a; box-shadow: 0 10px 30px rgba(0,0,0,0.7); }
    .close-modal { color: #9ca3af; }
    .close-modal:hover { color: #e5e7eb; }
    .run-backup { background: #065f46; border-color: #064e3b; }
    .run-backup:hover { background: #064e3b; }
}
</style>
{% endblock %}